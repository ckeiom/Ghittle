#include "types.h"
#include "page.h"



int init_pagetable()
{
	struct pagetable_entry* e;
	int i;
	DWORD map_addr;

	if( BOOT_LEVEL == BOOT_FAST_BOOT )
		return 0;

	/* PML4 table */
	e = (struct pagetable_entry*) PML4_START;

	set_pagetable( e, 0, PDPT_START, PAGE_DEFAULT, 0 );
	for (i=1; i<PAGE_MAXENTRY_COUNT; i++)
		set_pagetable( &(e[i]), 0, 0, 0, 0 );
	
	/* PDPT table */

	e = (struct pagetable_entry*) PDPT_START;

	for(i=0;i<64;i++)
	{
		set_pagetable( &(e[i]),0, PD_START + (i*PAGETABLE_SIZE), 
						PAGE_DEFAULT, 0 );
	}
	for(i=64;i<PAGE_MAXENTRY_COUNT ; i++)
	{
		set_pagetable( &(e[i]),0, 0, 0, 0 );
	}
	/* PD table */
	e = (struct pagetable_entry*) PD_START;

	map_addr = 0;

	for (i=0; i<512*64 ; i++)
	{
		set_pagetable( &(e[i]), ( i*(0x200000>>20) ) >>12,
						map_addr, PAGE_DEFAULT | PAGE_PAGESIZE, 0 );
		map_addr += PAGE_DEFAULT_SIZE;
	}

	return 0;

}
